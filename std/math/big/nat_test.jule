// Copyright 2024 The Jule Programming Language.
// Use of this source code is governed by a BSD 3-Clause
// license that can be found in the LICENSE file.

#build test

use testing for std::testing

static casesNatFromBits = [
	"1011010",
	"1111011000",
	"10001100011000",
	"10001101101110101011110110000110111111101101",
	"10001100011111",
	"11111111111111111111111110011",
]

static casesNatAdd = [
	["1011010", "1011010", "10110100"],
	["1011010", "0000001", "1011011"],
	["10011000000111", "100000101011101000", "100011000011101111"],
	["00000000000000", "00000000001", "1"],
	["100000101011101000", "111101100111111001", "1011110010011100001"],
]

static casesNatSub = [
	["1011010", "1011010", ""],
	["1011010", "0000001", "1011001"],
	["100000101011101000", "10011000000111", "11110010011100001"],
	["100010", "110111001110", "110110101100"],
	["10001100001110", "111101101", "10000100100001"],
	["1010", "10100", "1010"],
	["101011", "11000", "10011"],
	["11101110111011111111111011110101010010101101111010101101010101010101011110011010010110010101110110010101101011001011", "11101110111011111111111011110101010010101101111010101101010101010101011110011010010110010101110110010101101011001010", "1"],
]

static casesNatMul = [
	["1011010", "1011010", "1111110100100"],
	["1011010", "1", "1011010"],
	["1011010", "0", ""],
	["1100010", "100", "110001000"],
	["100", "1100010", "110001000"],
	["10001101101110101011110110000110111111101101", "10001101101110101011110110000110111111101101", "100111001110111001111001111111010101001001011000000000110101110110111110110000101101001"],
	["100111001110111001111001111111010101001001011000000000110101110110111110110000101101001", "100111001110111001111001111111010101001001011000000000110101110110111110110000101101001", "11000000011001110000010110100111100100110000001110100100100001110010010011011011110100000111000000011100100101001011101010001010001100010011110010101111111101011110100010001"],
	["1010", "10", "10100"],
	["10", "1010", "10100"],
	["1010101010101010101010101010101010101010101010", "10", "10101010101010101010101010101010101010101010100"],
	["10", "1010101010101010101010101010101010101010101010", "10101010101010101010101010101010101010101010100"],
	["1011", "101", "110111"],
	["100110111011001001000001111000001111101010110110011010001111110011111001011101001001011011110100101011000100000110110100001010010101000000111111101010000101011010111011110101110111100000010100100100111110010101100111101110011001100110100000101000011100101010010001010111011001000001100010001101011000010011010100011011111011111001100010100000000000100001001011110111100011000000001100000110110001001000000100110100100110010011110100010100000010011110101000001010110010110001010001110000010111110001111111001011000110110010110110011001110011000110100001101001001101001111110101111000011111000000100101101011111010001001100011001100110010001110100000111110001010001011001101001011101100001001101011001100001101001010010111011000101110010101111101010000110101111110110101010111011010000100001011011010000011000110100100000011010011111011110010000111110001011011111100010000100000101100100101001011101111101011000011011001111111100101010100101001001111100001001000111000111000101101101011010001001110000010100001011110010011110000101010111010100011010101110010111111011010111101110010001100111010011011101101010110000010001101100111010010000110011111001100", "1001110110010001000000010110100001101000011010010110010001101100110011111001100", "101111111010100100000110011100101111100010111010000100000001001011001110001101110100000110010010011110110001101010010100100100110011010011010001101011001010011111000000000101110010110100111100010101001000110111010111000011010101001101010001011001111101011110010110110101000010010011010000100110110001100111011110001100011110111100011100010001011011111011101111000011011010110100011000111111011111110010001011111101111111011001010001110110000110101111010100000011111110111111101101011101000110010100101000111110000111010000110001001101101010111101001110101010000000000110101110011001000110000100010100111000110010111111010111100001110010110110001110010000001010000110100111000001011110101110011111010110010111111001010010111100101101111111100011100110001111010110100000111101110101100111100110101111101101000101101011010101110111011110011101000100000101010000101010100001010101011110011100011000110110100100111001110100101110011100111000111100011010100001011000111110000101111011011010010000011101100001110111111000111000111001111101111011100101000110110011000101000110000110010011111000111111000101011110101101101011101011110010011000010010101000111100110001000001100110010000011011001000011010011000101100011111011100101010010000"],
	["100110111011001001000001111000001111101010110110011010001111110011111001011101001001011011110100101011000100000110110100001010010101000000111111101010000101011010111011110101110111100000010100100100111110010101100111101110011001100110100000101000011100101010010001010111011001000001100010001101011000010011010100011011111011111001100010100000000000100001001011110111100011000000001100000110110001001000000100110100100110010011110100010100000010011110101000001010110010110001010001110000010111110001111111001011000110110010110110011001110011000110100001101001001101001111110101111000011111000000100101101011111010001001100011001100110010001110100000111110001010001011001101001011101100001001101011001100001101001010010111011000101110010101111101010000110101111110110101010111011010000100001011011010000011000110100100000011010011111011110010000111110001011011111100010000100000101100100101001011101111101011000011011001111111100101010100101001001111100001001000111000111000101101101011010001001110000010100001011110010011110000101010111010100011010101110010111111011010111101110010001100111010011011101101010110000010001101100111010010000110011111001100", "10101011110000001101101110000010111111100010001110001001110111110101111000110110010011001011111100010001011000010100100100001000011001001111101010101110010101101100000000110100100110110100100101110111111110010111010011000100010001011011101010111011001000100010010111000100010001000000100101111101010100011011010101100001101110110000001111010000010000111101001011111011100111011100001001011011101001001101000011110100000010011001100", "1101000011101010101110100110011110110011010010101000110001111111000111000100110001110001101110100001111101110010111101001110100100100101010101111111110001001100011011010110001111001100101011110000111001101010000101110100000111110101101111001001110000111011000001101010110010100010011110110111110011001001001111010100011000100010000101110101011000011010101000100111111111011111001001010110100101111100111101000110101001000001101010010100100011101011110101101001111001111101000010011111010000111001010010001001010010001111001010000000110000111100110101110010110010010010111010101110101011001110010111100010010011100111111011001000000101101000111101110011010101101000100011101101011001111111001001110000110101100000011000010000111010000010101100101010100011000001000111100000100100111111100101010100001010101001110001111111111110110101001001110110001001010011101111011111110001001010111011101010000100001100011001000110001100000101100011110101011000100111010000011111110001111001000111101110110000100001011001100011010010110111101101101011010101111010100001101011100000110010100001110010000101011110111010111011001000000101000000101010001000010110010101101010010010110100010100101101100000000111100101100111011000110110010101110000110001100110011110000101010101001100010111000000100100010101111001111100001001000101010000001111111100101001101101001001000111100000000110101011001000000110001101001100001010001100110101110001011011001010101001111001101010000110000110101010011010000001010100011111111000111110110011101001101111001101000111011011011101011111000110100010011110011010010000"],
]

static casesNatDiv = [
	["1010", "1", "1010"],
	["1010", "10", "101"],
	["1000000", "110", "1010"],
	["1001100", "11", "11001"],
	["1000000", "100", "10000"],
	["11111011", "1101", "10011"],
	["10", "11", ""],
	["10011011001110001", "111", "10110001011001"],
	["10011001101010", "10", "1001100110101"],
	["1010101010101010101010101010101010101010101010", "10", "101010101010101010101010101010101010101010101"],
	["100111001110111001111001111111010101001001011000000000110101110110111110110000101101001", "10", "10011100111011100111100111111101010100100101100000000011010111011011111011000010110100"],
	["110101101011110101010100111", "110100", "1000010000100101101111"],
	["110101101011110101010100111", "11011001", "1111110101010101010"],
]

static casesNatMod = [
	["1010", "1010", ""],
	["1010", "1", ""],
	["111001010111011001", "1110110", "11111"],
	["11101110111011111111111011110101010010101101111010101101010101010101011110011010010110010101110110010101101011001011", "1110101", "1011001"],
	["11110110110101010101010101111111111011010101010101010101001111111001010101001010101010110000000011111101101001010111001111", "1110101", "1100001"],
	["0", "11100111", ""],
	["0", "0", ""],
	["110101101011110101010100111", "110100", "11011"],
	["1010", "11", "1"],
]

static casesNatSqrt = [
	["0", "0"],
	["1", "1"],
	["64", "8"],
	["128", "11"],
	["512", "22"],
	["1024", "32"],
	["123456789", "11111"],
	["93740370857", "306170"],
	["1111111111111111111", "1054092553"],
	["93849027509227502572857987593872096963976596397653974539407037034673407645843653065230958320593204572305725298749759659385740574087034689375348743864389675459843983564989384902750922750257285798759387209696397659639765397453940703703467340764584365306523095832059320457230572529874975965938574057408703468937534874386438967545984398356498", "9687570774411276659680011082160820212171697319806809142301378607022554906510534974930944633958323041094299447509399173334565374943237005677466395827754699057046061129399"],
]

static casesNatShl: [][]u64 = [
	[1, 8, 256],
	[9834, 32, 42236708388864],
	[9383, 0, 9383],
	[9383, 1, 18766],
	[0, 20, 0],
	[0, 0, 0],
	[123456789, 8, 31604937984],
]

static casesNatShr: [][]u64 = [
	[64, 2, 16],
	[256, 8, 1],
	[89357, 9, 174],
	[3759375747438473473, 49, 6677],
	[0, 90, 0],
	[2, 90, 0],
]

static casesNatBitOr: [][]u64 = [
	[20, 4, 20],
	[4, 20, 20],
	[345, 2, 347],
	[908474739, 747688553334, 748259113847],
	[97799739579632223, 1234567890, 97799739731806943],
]

static casesNatBitAnd: [][]u64 = [
	[902984, 24, 8],
	[24, 902984, 8],
	[902984, 2434, 256],
	[2434, 902984, 256],
	[77786486463864864, 97774749933, 19360907296],
	[123456789, 987654321, 39471121],
]

static casesNatBitXor: [][]u64 = [
	[10, 11, 1],
	[87793, 5, 87796],
	[5, 87793, 87796],
	[10, 1, 11],
	[1, 10, 11],
	[12345, 54321, 58376],
	[123, 321, 314],
	[1234567890, 9876543210, 8676316216],
]

static casesNatTrailingZeros = [
	[0b111010101010111101010110000000, 7],
	[0b111111111111111111111110000000, 7],
	[0, 0],
	[1, 0],
	[0b10, 1],
	[0b101101000, 3],
]

#test
fn testNatFromBits(t: &testing::T) {
	for _, c in casesNatFromBits {
		n := nat.parse(c, 2) else {
			t.Errorf("exceptional occurs: {}", error)
			continue
		}
		if len(n.bits) != len(c) {
			t.Errorf("{} != {}", c, c)
			continue
		}
		for i, b in n.bits {
			cb := c[len(c)-1-i]
			if b == 0b1 && cb != '1' ||
				b == 0b0 && cb != '0' {
				t.Errorf("{} != {}", c, c)
				break
			}
		}
	}
}

fn testCommonNatOp(&t: &testing::T, op: str, &cases: [][]str) {
	for _, c in cases {
		mut n1 := nat.parse(c[0], 2) else {
			t.Errorf("exception occurs: {}", error)
			continue
		}
		n2 := nat.parse(c[1], 2) else {
			t.Errorf("exception occurs: {}", error)
			continue
		}
		match op {
		| "+":
			n1 += n2
		| "-":
			n1 -= n2
		| "*":
			n1 *= n2
		| "/":
			n1 /= n2
		| "%":
			n1 %= n2
		}
		cr := c[2]
		if n1.len() != len(cr) {
			t.Errorf("{} {} {} != {}", c[0], op, c[1], cr)
			continue
		}
		for i, b in n1.bits {
			cb := cr[len(cr)-1-i]
			if b == 0b1 && cb != '1' ||
				b == 0b0 && cb != '0' {
				t.Errorf("{} {} {} != {}", c[0], op, c[1], cr)
				break
			}
		}
	}
}

#test
fn testNatAdd(t: &testing::T) {
	testCommonNatOp(t, "+", casesNatAdd)
}

#test
fn testNatSub(t: &testing::T) {
	testCommonNatOp(t, "-", casesNatSub)
}

#test
fn testNatMul(t: &testing::T) {
	testCommonNatOp(t, "*", casesNatMul)
}

#test
fn testNatDiv(t: &testing::T) {
	testCommonNatOp(t, "/", casesNatDiv)
}

#test
fn testNatMod(t: &testing::T) {
	testCommonNatOp(t, "%", casesNatMod)
}

#test
fn testNatSqrt(t: &testing::T) {
	for _, c in casesNatSqrt {
		x := nat.parse(c[0], 10)!
		sqrt := x.sqrt()
		s := sqrt.format(10)!
		if s != c[1] {
			t.Errorf("sqrt({}) != {}", c[0], c[1])
		}
	}
}

fn testNatBitBinary(&t: &testing::T, op: str, &cases: [][]u64) {
	for _, c in cases {
		mut n1 := nat.new(c[0])
		n2 := nat.new(c[1])
		match op {
		| "|":
			n1 |= n2
		| "&":
			n1 &= n2
		| "^":
			n1 ^= n2
		}
		u := n1.toU64()!
		if u != c[2] {
			t.Errorf("{} {} {} != {}", c[0], op, c[1], c[2])
		}
	}
}

#test
fn testNatBitOr(t: &testing::T) {
	testNatBitBinary(t, "|", casesNatBitOr)
}

#test
fn testNatBitAnd(t: &testing::T) {
	testNatBitBinary(t, "&", casesNatBitAnd)
}

#test
fn testNatBitXor(t: &testing::T) {
	testNatBitBinary(t, "^", casesNatBitXor)
}

#test
fn testNatShl(t: &testing::T) {
	for _, c in casesNatShl {
		n := nat.new(c[0])
		mut r := n << int(c[1])
		u := r.toU64()!
		if u != c[2] {
			t.Errorf("{} << {} != {}", c[0], c[1], c[2])
		}
	}
}

#test
fn testNatShr(t: &testing::T) {
	for _, c in casesNatShr {
		n := nat.new(c[0])
		mut r := n >> int(c[1])
		u := r.toU64()!
		if u != c[2] {
			t.Errorf("{} >> {} != {}", c[0], c[1], c[2])
		}
	}
}

#test
fn testNatTrailingBits(t: &testing::T) {
	for _, c in casesNatTrailingZeros {
		n := nat.new(c[0])
		zeros := n.trailingZeros()
		if zeros != c[1] {
			t.Errorf("expected {}, found {}, for input {}", c[1], zeros, c[0])
		}
	}
}

#test
fn testNatLt(t: &testing::T) {
	t.Assert(!nat.parse("1011010", 2)!.Lt(nat.parse("00001011010", 2)!), "1) 1011010 < 00001011010")
	t.Assert(!nat.parse("1111011000", 2)!.Lt(nat.parse("000000000001111011000", 2)!), "2) 1111011000 < 000000000001111011000")
	t.Assert(!nat.parse("10001100011000", 2)!.Lt(nat.parse("100011", 2)!), "3) 10001100011000 < 100011")
	t.Assert(!nat.parse("10001101101110101011110110000110111111101111", 2)!.Lt(nat.parse("10001101101110101011110110000110111111101101", 2)!), "4) 10001101101110101011110110000110111111101111 < 10001101101110101011110110000110111111101101")
}

#test
fn testNatGt(t: &testing::T) {
	t.Assert(!nat.parse("1011010", 2)!.Gt(nat.parse("00001011010", 2)!), "1) 1011010 > 00001011010")
	t.Assert(!nat.parse("1111011000", 2)!.Gt(nat.parse("000000000001111011000", 2)!), "2) 1111011000 > 000000000001111011000")
	t.Assert(nat.parse("10001100011000", 2)!.Gt(nat.parse("100011", 2)!), "3) 10001100011000 <= 100011")
	t.Assert(nat.parse("10001101101110101011110110000110111111101111", 2)!.Gt(nat.parse("10001101101110101011110110000110111111101101", 2)!), "4) 10001101101110101011110110000110111111101111 <= 10001101101110101011110110000110111111101101")
	t.Assert(!nat.parse("10000100100001", 2)!.Gt(nat.parse("10011001101010", 2)!), "5) 10000100100001 >= 10011001101010")
}

#test
fn testNatEq(t: &testing::T) {
	t.Assert(nat.parse("1011010", 2)!.Eq(nat.parse("00001011010", 2)!), "1) 1011010 != 00001011010")
	t.Assert(nat.parse("1111011000", 2)!.Eq(nat.parse("000000000001111011000", 2)!), "2) 1111011000 != 000000000001111011000")
	t.Assert(nat.parse("10001100011000", 2)!.Eq(nat.parse("10001100011000", 2)!), "3) 10001100011000 != 10001100011000")
	t.Assert(nat.parse("10001101101110101011110110000110111111101101", 2)!.Eq(nat.parse("10001101101110101011110110000110111111101101", 2)!), "4) 10001101101110101011110110000110111111101101 != 10001101101110101011110110000110111111101101")
}